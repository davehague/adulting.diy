# Test Plan: Occurrence Scheduling & Notification System
**Date:** July 2, 2025  
**Features:** Complete occurrence scheduler, email notifications, user preferences  
**Test Environment:** Local development with email service enabled

## Prerequisites
- Application running locally
- Email service (Mailjet) configured with valid API keys
- At least 2 users in a household for notification testing
- Valid email addresses for receiving test notifications

---

## Test Suite 1: Occurrence Scheduling System

### Test 1.1: One-Time Task Scheduling
**Objective:** Validate "once" type tasks generate exactly one occurrence

**Steps:**
1. Navigate to Tasks page and click "Create Task"
2. Fill in:
   - Name: "Test One-Time Task"
   - Category: Any
   - Schedule Type: "Once"
   - Due Date: Tomorrow's date
3. Click "Create Task"

**Expected Results:**
- ✅ Task appears in task list
- ✅ Navigate to task detail page → shows exactly 1 occurrence
- ✅ Occurrence has status "created" or "assigned" (depending on default assignees)
- ✅ Occurrence due date matches the specified date

### Test 1.2: Fixed Interval Scheduling
**Objective:** Test recurring tasks with fixed intervals

**Steps:**
1. Create new task with:
   - Name: "Test Weekly Task"
   - Schedule Type: "Fixed Interval"
   - Interval: 1 week
   - No end condition
2. Save task
3. Call scheduler manually: `POST /api/scheduler/run`
4. Check task occurrences page

**Expected Results:**
- ✅ Multiple occurrences generated (up to 3 months ahead)
- ✅ Occurrences are exactly 7 days apart
- ✅ All occurrences have status "created" or "assigned"

### Test 1.3: Specific Days of Week
**Objective:** Test tasks scheduled for specific weekdays

**Steps:**
1. Create task with:
   - Name: "Test Weekday Task"
   - Schedule Type: "Specific Days of Week"
   - Select: Monday, Wednesday, Friday
2. Run scheduler
3. Check generated occurrences

**Expected Results:**
- ✅ Occurrences only appear on Mon/Wed/Fri
- ✅ No occurrences on Tue/Thu/Sat/Sun
- ✅ Pattern continues for ~3 months

### Test 1.4: End Conditions
**Objective:** Test that tasks stop generating when end conditions are met

**Steps:**
1. Create task with:
   - Name: "Test Limited Task"
   - Schedule Type: "Fixed Interval" (daily)
   - End Condition: "After 5 occurrences"
2. Run scheduler
3. Count generated occurrences

**Expected Results:**
- ✅ Exactly 5 occurrences generated
- ✅ No additional occurrences beyond the limit

---

## Test Suite 2: Occurrence Lifecycle & Auto-Generation

### Test 2.1: Complete Task → Generate Next
**Objective:** Verify that completing an occurrence triggers next occurrence generation

**Steps:**
1. Find a recurring task with an occurrence due today
2. Navigate to the occurrence detail page
3. Click "Complete" button
4. Check if new occurrence appears in the list

**Expected Results:**
- ✅ Occurrence status changes to "completed"
- ✅ New occurrence automatically generated with future due date
- ✅ New occurrence has correct due date based on schedule type

### Test 2.2: Skip Task → Generate Next
**Objective:** Test that skipping also triggers next occurrence

**Steps:**
1. Find another recurring task occurrence
2. Click "Skip" button
3. Enter skip reason: "Testing skip functionality"
4. Submit

**Expected Results:**
- ✅ Occurrence status changes to "skipped"
- ✅ Skip reason appears in occurrence timeline
- ✅ New occurrence generated for future date

### Test 2.3: Variable Interval Scheduling
**Objective:** Test that variable intervals use completion date

**Steps:**
1. Create task with:
   - Schedule Type: "Variable Interval"
   - Interval: "2 weeks after completion"
2. Complete the first occurrence today
3. Check when next occurrence is scheduled

**Expected Results:**
- ✅ Next occurrence due date is exactly 2 weeks from completion date
- ✅ Not based on original due date

---

## Test Suite 3: Email Notification System

### Test 3.1: Task Creation Notifications
**Objective:** Test notifications when new tasks are created

**Setup:** Ensure you have another user in your household with valid email

**Steps:**
1. Create a new task
2. Check email inbox of other household member
3. Verify notification preferences are set to receive task creation emails

**Expected Results:**
- ✅ Other household members receive email notification
- ✅ Email contains task name, description, category
- ✅ Email has link to view the task
- ✅ Task creator does NOT receive notification

### Test 3.2: Occurrence Assignment Notifications
**Objective:** Test notifications when occurrences are assigned

**Steps:**
1. Create task with default assignees
2. Check assignee email inbox
3. Or manually assign existing occurrence to another user

**Expected Results:**
- ✅ Assigned user receives email notification
- ✅ Email contains task name and due date
- ✅ Email has link to occurrence detail page

### Test 3.3: Occurrence Completion Notifications
**Objective:** Test notifications when tasks are completed

**Steps:**
1. Complete an occurrence assigned to you
2. Check if other household members receive notification
3. Verify notification preferences support this

**Expected Results:**
- ✅ Household members receive completion notification (if preferences allow)
- ✅ Email contains who completed the task and when

### Test 3.4: Task Reminder Notifications
**Objective:** Test reminder system functionality

**Setup:** Create task with reminder configuration

**Steps:**
1. Create task with:
   - Initial reminder: 1 day before due
   - Follow-up reminder: Same day as due
   - Overdue reminder: 1 day after due
2. Set system date to trigger reminders OR call `POST /api/scheduler/reminders`
3. Check email inbox

**Expected Results:**
- ✅ Reminder emails sent at appropriate times
- ✅ Email subject indicates how many days until/past due
- ✅ Email contains task details and completion link

---

## Test Suite 4: Notification Preferences

### Test 4.1: Access Notification Preferences
**Objective:** Test user can view and modify notification settings

**Steps:**
1. Navigate to user profile/settings page
2. Look for notification preferences section
3. Check current preference values

**Expected Results:**
- ✅ Notification preferences section is visible
- ✅ Shows current settings for all notification types
- ✅ Options include "Any", "Mine", "None" for each category

### Test 4.2: Update Notification Preferences
**Objective:** Test that preference changes are saved and respected

**Steps:**
1. Change "Task Created" preference to "None"
2. Save preferences
3. Create a new task
4. Verify no email is sent

**Expected Results:**
- ✅ Preferences save successfully
- ✅ No email notification sent for task creation
- ✅ Other notification types still work

### Test 4.3: "Mine" vs "Any" Preference Logic
**Objective:** Test that "Mine" only sends notifications for user-related items

**Steps:**
1. Set "Occurrence Executed" to "Mine"
2. Complete an occurrence assigned to you → should get notification
3. Have another user complete their occurrence → should NOT get notification
4. Change to "Any" and repeat → should get both notifications

**Expected Results:**
- ✅ "Mine" only sends notifications for user's own occurrences
- ✅ "Any" sends notifications for all household occurrences

---

## Test Suite 5: System Integration Tests

### Test 5.1: Scheduler API Endpoints
**Objective:** Test manual scheduler triggers work correctly

**Steps:**
1. Use API testing tool (Postman/curl) or browser dev tools
2. Call `POST /api/scheduler/run`
3. Call `POST /api/scheduler/reminders`
4. Check response and database for changes

**Expected Results:**
- ✅ `/api/scheduler/run` returns count of tasks processed and occurrences generated
- ✅ `/api/scheduler/reminders` returns count of reminders sent
- ✅ No error responses

### Test 5.2: Error Handling
**Objective:** Test system gracefully handles notification failures

**Steps:**
1. Temporarily break email configuration (invalid API key)
2. Complete an occurrence that should trigger notification
3. Check that occurrence completion still works

**Expected Results:**
- ✅ Occurrence completion succeeds even if email fails
- ✅ Error logged but doesn't crash the application
- ✅ Fix email config and notifications resume working

### Test 5.3: Comment Notifications
**Objective:** Test notifications for occurrence comments

**Steps:**
1. Navigate to occurrence detail page
2. Add a comment: "Testing comment notifications"
3. Check other household members' email

**Expected Results:**
- ✅ Comment appears in occurrence timeline
- ✅ Household members receive comment notification email
- ✅ Email contains comment text and link to occurrence

---

## Test Suite 6: Edge Cases & Data Validation

### Test 6.1: Invalid Schedule Configurations
**Objective:** Test system handles malformed schedule data

**Steps:**
1. Try creating task with invalid recurrence data (if possible via UI)
2. Check for appropriate error messages

**Expected Results:**
- ✅ Invalid configurations are rejected with clear error messages
- ✅ No corrupted tasks created

### Test 6.2: Large Date Ranges
**Objective:** Test scheduler with tasks far in the future

**Steps:**
1. Create task scheduled for 6 months in the future
2. Run scheduler
3. Verify reasonable number of occurrences generated

**Expected Results:**
- ✅ Only ~3 months of occurrences generated (horizon limit)
- ✅ No infinite loops or performance issues

### Test 6.3: Concurrent User Actions
**Objective:** Test notifications work with multiple users acting simultaneously

**Steps:**
1. Have multiple users complete different occurrences at the same time
2. Check that all appropriate notifications are sent
3. Verify no duplicate or missing notifications

**Expected Results:**
- ✅ All expected notifications sent
- ✅ No notification spam or missing alerts

---

## Testing Checklist Summary

**Core Functionality:**
- [ ] All 6 schedule types generate correct occurrences  
- [ ] End conditions properly limit occurrence generation
- [ ] Completing/skipping generates next occurrence automatically
- [ ] Scheduler APIs work manually

**Email Notifications:**
- [ ] Task creation/pause/delete notifications
- [ ] Occurrence assign/execute/skip/comment notifications  
- [ ] Task reminders (initial/follow-up/overdue)
- [ ] User preferences properly filter notifications

**User Experience:**
- [ ] Notification preferences UI works
- [ ] Preference changes are saved and respected
- [ ] Email templates are properly formatted
- [ ] All links in emails work correctly

**System Reliability:**
- [ ] Email failures don't break core functionality
- [ ] No infinite loops in occurrence generation
- [ ] Performance acceptable with large datasets
- [ ] Error handling provides useful feedback

---

## Notes for Tester

1. **Email Testing:** Use real email addresses to fully test the notification system
2. **Time Zones:** Be aware of server time zone when testing date-based features
3. **Database State:** Some tests may require resetting occurrence data between test runs
4. **API Testing:** Use browser dev tools Network tab or Postman for API endpoint testing
5. **Log Monitoring:** Check server logs for any errors during testing

**Critical Success Metrics:**
- Zero application crashes during testing
- All emails delivered with correct content and formatting
- Occurrence generation follows exact schedule mathematics
- User preferences consistently respected across all notification types